stages:
  - test
  - build
  - push
  - deploy

variables:
  IMAGE_NAME: "express-ci"

# ===== Test stage =====
test-app:
  stage: test
  tags:
    - local-vm
  script:
    - echo "==> Installing dependencies"
    - npm install
    - echo "==> Running tests"
    - npm test
  only:
    - main

# ===== Build Docker image =====
build-image:
  stage: build
  tags:
    - local-vm
  script:
    - echo "==> Building Docker image"
    - docker build -t $IMAGE_NAME:latest .
  only:
    - main

# ===== Push Docker image =====
push-image:
  stage: push
  tags:
    - local-vm
  script:
    - echo "==> Logging into Docker Hub"
    - echo "$DOCKERHUB_TOKEN" | docker login -u "$DOCKERHUB_USERNAME" --password-stdin
    - echo "==> Tagging image"
    - docker tag $IMAGE_NAME:latest $DOCKERHUB_USERNAME/$IMAGE_NAME:latest
    - echo "==> Pushing image"
    - docker push $DOCKERHUB_USERNAME/$IMAGE_NAME:latest
  only:
    - main

# ===== Deploy stage =====
deploy-to-local:
  stage: deploy
  tags:
    - local-vm
  script:
    - echo "==> Pulling latest image"
    - docker pull $DOCKERHUB_USERNAME/$IMAGE_NAME:latest
    - echo "==> Stopping old container"
    - docker stop express-ci || true
    - echo "==> Removing old container"
    - docker rm express-ci || true
    - echo "==> Starting new container"
    - docker run -d --name express-ci -p 3000:3000 --restart=always $DOCKERHUB_USERNAME/$IMAGE_NAME:latest
  only:
    - main
